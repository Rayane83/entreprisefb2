#!/bin/bash

echo "ğŸš€ LANCEMENT VERSION COMPLÃˆTE - Portail Entreprise Flashback Fa v2.0"
echo "====================================================================="

echo ""
echo "ğŸ“‹ VÃ©rification de l'Ã©tat actuel des services..."
sudo supervisorctl status

echo ""
echo "ğŸ”„ RedÃ©marrage de tous les services pour la version complÃ¨te..."
sudo supervisorctl restart all

echo ""
echo "â³ Attente du dÃ©marrage des services (15 secondes)..."
sleep 15

echo ""
echo "âœ… VÃ©rification de l'Ã©tat final..."
sudo supervisorctl status

echo ""
echo "ğŸŒ Test de connectivitÃ©..."
frontend_status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000)
backend_status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8001/api/)

echo "Frontend: $frontend_status"
echo "Backend: $backend_status"

if [ "$frontend_status" = "200" ] && [ "$backend_status" = "200" ]; then
    echo ""
    echo "ğŸ‰ VERSION COMPLÃˆTE LANCÃ‰E AVEC SUCCÃˆS !"
    echo "====================================================================="
    echo ""
    echo "ğŸ“ ACCÃˆS Ã€ L'APPLICATION:"
    echo "   ğŸ”— URL: http://localhost:3000"
    echo ""
    echo "ğŸ†• TOUTES LES FONCTIONNALITÃ‰S DISPONIBLES:"
    echo ""
    echo "   âœ… PROBLÃˆMES RÃ‰SOLUS:"
    echo "   â€¢ Tous les boutons rÃ©parÃ©s et fonctionnels"
    echo "   â€¢ Navigation fluide dans toute l'application"
    echo "   â€¢ Exports Excel opÃ©rationnels"
    echo ""
    echo "   ğŸš€ NOUVELLES FONCTIONNALITÃ‰S:"
    echo "   â€¢ Page 'Gestion des Entreprises' complÃ¨te"
    echo "   â€¢ Formulaire d'ajout d'entreprise avec 4 champs:"
    echo "     - Nom de l'entreprise"
    echo "     - ID Guild Discord"
    echo "     - ID RÃ´le Principal"
    echo "     - ğŸ†• ID RÃ´le Membre (pour compter employÃ©s)"
    echo "   â€¢ Configuration rÃ´les Dot Guild (Staff/Patron/Co-Patron/DOT)"
    echo "   â€¢ Bouton 'Page Principale' pour navigation"
    echo "   â€¢ Interface responsive et cohÃ©rente"
    echo ""
    echo "   ğŸ­ MODE DÃ‰VELOPPEMENT:"
    echo "   â€¢ Connexion automatique (rÃ´le Staff)"
    echo "   â€¢ AccÃ¨s complet Ã  toutes les fonctionnalitÃ©s"
    echo "   â€¢ Tests et dÃ©veloppement facilitÃ©s"
    echo ""
    echo "ğŸ¯ GUIDE D'UTILISATION RAPIDE:"
    echo "   1. ğŸŒ Ouvrir http://localhost:3000"
    echo "   2. ğŸ­ Connexion automatique en tant que Staff"
    echo "   3. ğŸ‘† Cliquer sur 'Gestion Entreprises' (header, bouton violet)"
    echo "   4. â• Tester l'ajout d'une nouvelle entreprise"
    echo "   5. âš™ï¸  Configurer les rÃ´les dans l'onglet 'Configuration RÃ´les'"
    echo "   6. ğŸ  Utiliser 'Page Principale' pour retourner au dashboard"
    echo ""
    echo "ğŸ”§ FONCTIONNALITÃ‰S AVANCÃ‰ES:"
    echo "   â€¢ Export Excel sur toutes les pages (ImpÃ´ts, Blanchiment, etc.)"
    echo "   â€¢ Zone copier-coller pour import de donnÃ©es"
    echo "   â€¢ SystÃ¨me de rÃ´les et permissions"
    echo "   â€¢ Configuration entreprise complÃ¨te"
    echo ""
    echo "ğŸ“Š COMPTAGE D'EMPLOYÃ‰S:"
    echo "   â€¢ Le champ 'ID RÃ´le Membre' permet de compter automatiquement"
    echo "   â€¢ le nombre d'employÃ©s ayant ce rÃ´le dans Discord"
    echo "   â€¢ Statistiques en temps rÃ©el des effectifs par entreprise"
    echo ""
    echo "ğŸ› ï¸  SCRIPTS DISPONIBLES:"
    echo "   â€¢ bash /app/launch-version-complete.sh (ce script)"
    echo "   â€¢ bash /app/switch-to-production.sh (Discord rÃ©el)"
    echo "   â€¢ bash /app/restore-mock-mode.sh (retour dÃ©veloppement)"
    echo ""
    echo "ğŸ“‹ LOGS EN TEMPS RÃ‰EL:"
    echo "   Frontend: tail -f /var/log/supervisor/frontend.out.log"
    echo "   Backend:  tail -f /var/log/supervisor/backend.out.log"
    echo ""
    echo "====================================================================="
    echo "ğŸŠ VOTRE APPLICATION EST PRÃŠTE AVEC TOUTES LES AMÃ‰LIORATIONS !"
    echo "====================================================================="
else
    echo ""
    echo "âš ï¸  PROBLÃˆME DÃ‰TECTÃ‰:"
    echo "   Frontend Status: $frontend_status (attendu: 200)"
    echo "   Backend Status: $backend_status (attendu: 200)"
    echo ""
    echo "ğŸ” VÃ‰RIFICATION DES LOGS:"
    echo "   sudo tail -n 20 /var/log/supervisor/frontend.err.log"
    echo "   sudo tail -n 20 /var/log/supervisor/backend.err.log"
    echo ""
    echo "ğŸ”„ TENTATIVE DE REDÃ‰MARRAGE:"
    echo "   sudo supervisorctl restart all"
fi